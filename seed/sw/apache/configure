#!/bin/bash

# This is the Webino Seed install script!
# Version: @@version@@
#
# Are you looking at this in your web browser, and would like to run Webino Seed?
# Just open up your terminal and type:
#
#    wget https://get.webino.org/seed/apache -qO- | sh
#
# Webino currently supports:
#   - Ubuntu 12.04 (wget 1.14)
#   - Ubuntu 14.04
#
# What this script does?
#   - It builds Apache from source

main() {
    echo 'Configuring Apache...'
    local etc='/etc/apache2'
    local data='https://get.webino.org/seed/data/etc'

    sudo apachectl stop
    sudo chsh -s /bin/bash www-data

    # directories
    sudo mkdir -p $etc/conf.d
    sudo mkdir -p $etc/common
    sudo mkdir -p /var/log/apache2
    sudo chown syslog:adm /var/log/apache2 -R
    sudo rm -f /usr/local/apache2/cgi-bin/*

    # TODO configure host (local only)
    #[[ -n $env_local ]] &&

    # httpd
    local httpd_is_configured=$(grep conf.d $etc/httpd.conf)
    if [ "$httpd_is_configured" == "" ]; then
        echo 'Configuring "etc/apache2/httpd.conf"...'
        echo "Include $etc/conf.d/" | sudo tee --append $etc/httpd.conf > /dev/null
    fi

    sudo wget -qO $etc/conf.d/webino.conf $data/apache2/conf.d/webino.conf

    # TODO webino-local.conf (local only)
    #[[ -n $env_local ]] &&

    sudo wget -qO $etc/conf.d/mods-enabled.conf $data/apache2/conf.d/mods-enabled.conf

    sudo wget -qO $etc/common/maintenance.conf $data/apache2/common/maintenance.conf

    # common configs
    echo 'Installing common configs...'
    sudo wget -qO $etc/common/vhost.conf $data/apache2/common/vhost.conf

    sudo wget -qO $etc/common/webino-vhost.conf $data/apache2/common/webino-vhost.conf

    sudo wget -qO $etc/common/dir.conf $data/apache2/common/dir.conf

    sudo wget -qO $etc/common/webino-dir.conf $data/apache2/common/webino-dir.conf

    sudo wget -qO $etc/conf.d/security.conf $data/apache2/conf.d/security.conf

    sudo wget -qO $etc/conf.d/general.conf $data/apache2/conf.d/general.conf

    sudo wget -qO $etc/conf.d/php.conf $data/apache2/conf.d/php.conf

    # bad-bots
    echo 'Installing Bad-bot-blocker config...'
    sudo wget -qO $etc/common/bad-bot-blocker.conf \
        https://raw.githubusercontent.com/bluedragonz/bad-bot-blocker/master/.htaccess 2>&1

    echo '<Directory />' | sudo cat - $etc/common/bad-bot-blocker.conf > temp
    sudo mv temp $etc/common/bad-bot-blocker.conf
    echo '</Directory>' | sudo tee --append $etc/common/bad-bot-blocker.conf > /dev/null

    # TODO conf.d/ssl.conf

    # logs
    echo 'Configuring logrotate...'
    sudo mkdir -p /etc/logrotate.d/httpd-prerotate
    sudo wget -qO /etc/logrotate.d/apache2 $data/logrotate.d/apache2

    # logrotate vhosts (dev|pub only)
    [[ -n $env_dev || -n $env_pub ]] && \
        sudo wget -qO /etc/logrotate.d/apache2-vhosts $data/logrotate.d/apache2-vhosts

    return 0
}

main
